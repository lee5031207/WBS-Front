# https://tech.kakaoent.com/front-end/2022/220106-github-actions/
# https://github.com/actions ðŸ‘ˆì—¬ê¸°ì„œ actions í™•ì¸ ê°€ëŠ¥

name: "deploy_wbs_front"

# main ë¸Œëžœì¹˜ì— push ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë¨
on:
  push:
    branched: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: âœ” ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: âœ” Node.js(v22.14.0) ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0

      - name: âœ” npm ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
        run: |
          npm install
          npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ”’ SSH key íŒŒì¼ ìƒì„±
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: ðŸ”’ Copy files to EC2
        run: |
          scp -i ec2_key.pem -o StrictHostKeyChecking=no -r ./build ubuntu@${{ secrets.EC2_HOST }}:/app/frontend/

      - name: ðŸ”’ nginx reload ì‹¤í–‰ ì²˜ë¦¬
        run: |
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            sudo chmod -R 775 /app/frontend/build
            sudo systemctl restart nginx
          EOF
